# API Node Testing Design

## Concept

Some Hanzo Studio nodes need to be tested via the API rather than the browser UI. This requires a different testing workflow.

## API Testing vs UI Testing

### UI Testing (Current):

- Load Hanzo Studio in browser
- Paste browser script
- Run `await QA.testPack('pack-name')`
- Downloads workflow JSON
- Visual confirmation nodes work

### API Testing (New):

- Run Hanzo Studio server locally
- Use Python/curl to call API endpoints
- Test node execution via `/prompt` endpoint
- Validate outputs programmatically
- Test without UI interaction

## Implementation Options

### Option 1: Python Script Generator

Generate Python scripts to test API nodes:

```python
# Generated by comfy-qa
import requests
import json

# Test pack: my-api-pack
def test_node_execution():
    response = requests.post('http://localhost:8188/prompt', json={
        "prompt": {...}  # Generated prompt
    })
    assert response.status_code == 200
    # More validation...
```

### Option 2: Built-in API Client (Rust)

Add API testing capability to the CLI itself:

```
comfy-qa test-api <pack-name> --server http://localhost:8188
```

### Option 3: Separate Checklist for API Tests

Keep API tests separate from UI tests:

- `checklist-ui.md` - Browser-tested nodes
- `checklist-api.md` - API-tested nodes
- `checklist-both.md` - Nodes tested both ways

### Option 4: Unified with Markers

Single checklist with markers:

```markdown
- [x] NodeA (UI tested)
- [x] NodeB (API tested)
- [x] NodeC (Both)
- [ ] NodeD
```

## Recommended Approach: Option 1 + Option 4

**Why:**

- Python scripts are more flexible than Rust HTTP client
- Users can modify/extend scripts
- Unified checklist keeps things simple
- Markers show test method without separate files

## Implementation Plan

### 1. Add "Generate API Test Script" Command

Dashboard option: "Generate API test script"

Prompts:

1. Select pack to test
2. Select nodes to include (or all)
3. Hanzo Studio server URL (default: http://localhost:8188)
4. Where to save (same as workflow generator)

Generates Python script:

```python
#!/usr/bin/env python3
"""
API Test Script for: pack-name
Generated by comfy-qa

Instructions:
1. Start Hanzo Studio server: python main.py
2. Run this script: python test-pack-name.py
3. Check results
4. Mark nodes as tested in checklist
"""

import requests
import json
import sys

SERVER_URL = "http://localhost:8188"

def test_node_a():
    """Test NodeA functionality"""
    prompt = {
        "1": {
            "class_type": "NodeA",
            "inputs": {...}
        }
    }

    response = requests.post(f"{SERVER_URL}/prompt", json={"prompt": prompt})

    if response.status_code != 200:
        print(f"✗ NodeA failed: {response.status_code}")
        return False

    print("✓ NodeA passed")
    return True

def main():
    tests = [test_node_a, test_node_b, ...]
    passed = sum(1 for test in tests if test())
    total = len(tests)

    print(f"\nResults: {passed}/{total} passed")
    sys.exit(0 if passed == total else 1)

if __name__ == "__main__":
    main()
```

### 2. Update Checklist Format

Support markers in checklist.md:

```markdown
- [x] NodeA (130) <!-- UI tested -->
- [x] NodeB (45) <!-- API tested -->
- [x] NodeC (12) <!-- Both -->
- [ ] NodeD (89)
```

Parser recognizes markers, stats show breakdown:

```
Progress: 34/34 tested
  UI: 20
  API: 10
  Both: 4
```

### 3. Add API Test Instructions to Help

Update help guide with API testing workflow:

1. Generate API test script
2. Start Hanzo Studio server
3. Run Python script
4. Mark nodes in checklist with marker
5. Commit as usual

### 4. Validation for API Tests

Validate that API-marked nodes have corresponding test scripts or proof of testing.

## File Structure

```
api-tests/
  generated-local/         # Local API tests (gitignored)
    test-pack-a.py
  generated-shared/        # Committed API tests
    test-pack-b.py

workflows/
  generated-local/         # UI workflow tests
  generated-shared/
```

## User Stories

**Story 1: Testing API-only nodes**

```
User: My pack has nodes that only work via API
1. Dashboard → "Generate API test script"
2. Select pack, select nodes
3. Script generated with instructions
4. User runs: python main.py (start Hanzo Studio)
5. User runs: python test-pack-name.py
6. Results show which nodes work
7. User marks in checklist with <!-- API tested -->
8. Commit and push
```

**Story 2: Mixed UI + API testing**

```
User: Some nodes UI, some API
1. Test UI nodes with browser script (existing workflow)
2. Generate API script for API-only nodes
3. Run both tests
4. Mark checklist with appropriate markers
5. Stats show: "20 UI, 10 API, 30 total"
```

## Implementation Steps

1. Create `api-tests/` folder structure
2. Add API test script generator command
3. Update checklist parser to recognize markers
4. Update stats/progress to show breakdown
5. Add validation for API test markers
6. Update help guide
7. Add to .gitignore: `api-tests/generated-local/`

## Simple First Version

For MVP:

- Just generate basic Python script template
- Manual test execution
- Manual marking with comments
- No automated validation (yet)
- Instructions in comments

Can enhance later:

- Automated test execution from CLI
- Test result import
- Automatic checklist marking
- Test coverage reports
